<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ù…Ø§ÛŒØ´ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ NATI</title>
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css"

      rel="stylesheet"
    /> -->
    <link rel="stylesheet" href="/Files/bootstrap.rtl.min.css" />
    <!-- <link src="Files/bootstrap.rtl.min.css" rel="stylesheet" /> -->

    <style>
      body {
        background: #f6f6fb;
        overflow: hidden;
        height: 100vh;
        display: flex;
        direction: rtl;
      }
      #sidebar {
        width: 260px;
        min-width: 60px;
        max-width: 400px;
        background: #fff;
        border-left: 1px solid #ddd;
        overflow-y: auto;
        padding: 12px;
        box-shadow: -2px 0 6px rgba(0, 0, 0, 0.05);
        transition: width 0.3s ease;
      }
      #sidebar.collapsed {
        width: 0;
        padding: 0;
        overflow: hidden;
      }
      #toggleSidebar {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1100;
        background: #007bff;
        color: #fff;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 4px;
      }
      #main {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        transition: margin-right 0.3s ease;
        /* margin-right: 260px; */
      }
      #sidebar.collapsed + #main {
        margin-right: 0;
      }

      .sheet-item {
        padding: 10px;
        margin: 6px 0;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #e0e0ef;
        background: #fafafa;
        font-size: 15px;
      }
      .sheet-item:hover {
        background: #eef;
      }
      .sheet-item.active {
        background: #dde5ff;
        border-color: #b9c6ff;
      }

      .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1055;
      }

      .recording-indicator {
        width: 10px;
        height: 10px;
        background: red;
        border-radius: 50%;
        margin-left: 6px;
        animation: blink 1s infinite;
        display: none;
      }
      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0;
        }
      }

      .btn-fixed {
        height: 32px;
        font-size: 13px;
        line-height: 1;
        padding: 0 4px;
        overflow: hidden;
        display: block;
        width: 100%;
      }

      td.row-number {
        width: 5%;
        text-align: center;
        vertical-align: middle;
      }
      td.controls-cell {
        width: 10%;
      }
      td.dialog-cell {
        width: 85%;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <!-- Sidebar -->
    <div id="sidebar">
      <h3>Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
      <div id="sheetList">â€” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ â€”</div>
      <hr />
      <div id="audioInputContainer" class="mb-2" style="display: none">
        <label>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ (ÛŒÚ©Ø¬Ø§):</label>
        <input
          id="audioFiles"
          type="file"
          accept="audio/*"
          multiple
          class="form-control form-control-sm"
        />
      </div>
    </div>

    <button id="toggleSidebar" onclick="toggleSidebar()">â˜°</button>

    <!-- Main -->
    <div id="main">
      <h2 id="sheetTitle">Ú¯ÙØªÚ¯Ùˆ</h2>
      <div id="tableContainer">â€” Ù‡ÛŒÚ† Ø´ÛŒØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ â€”</div>
    </div>

    <div
      id="toast"
      class="toast align-items-center text-white bg-dark border-0"
      role="alert"
    ></div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- <script src="Files/xlsx.full.min.js"></script>
    <script src="Files/bootstrap.bundle.min.js"></script> -->
    <script>
      let workbook = null,
        currentAudio = null,
        currentBtn = null;
      let mediaRecorder = null,
        recordedChunks = [],
        mediaStream = null;

      const sheetList = document.getElementById("sheetList");
      const audioInput = document.getElementById("audioFiles");
      const audioInputContainer = document.getElementById(
        "audioInputContainer"
      );
      const tableContainer = document.getElementById("tableContainer");
      const sheetTitle = document.getElementById("sheetTitle");
      const toastEl = document.getElementById("toast");
      const sidebar = document.getElementById("sidebar");
      const bsToast = new bootstrap.Toast(toastEl);

      function showToast(msg) {
        toastEl.textContent = msg;
        bsToast.show();
      }

      /* ---------------- Load default Excel ---------------- */
      async function loadDefaultExcel() {
        try {
          const response = await fetch("Conversations.xlsx");
          const arrayBuffer = await response.arrayBuffer();
          workbook = XLSX.read(arrayBuffer, { type: "array" });

          renderSheetList();

          if (workbook.SheetNames.length > 0) {
            const first = workbook.SheetNames[0];
            const el = sheetList.querySelector(".sheet-item");
            selectSheet(first, el);
          }
        } catch (err) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:", err);
          sheetList.textContent = "â€” ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ â€”";
        }
      }

      /* --------------- Render sheet list ------------------ */
      function renderSheetList() {
        sheetList.innerHTML = "";
        workbook.SheetNames.forEach((name) => {
          const div = document.createElement("div");
          div.className = "sheet-item";
          div.textContent = name;
          div.onclick = () => selectSheet(name, div);
          sheetList.appendChild(div);
        });
      }

      /* --------------- Select sheet ------------------ */
      function selectSheet(name, element) {
        [...document.querySelectorAll(".sheet-item")].forEach((el) =>
          el.classList.remove("active")
        );
        element.classList.add("active");
        sheetTitle.textContent = `Ú¯ÙØªÚ¯Ùˆ: ${name}`;
        showToast(`Ø¯ÛŒØ§Ù„ÙˆÚ¯: ${name}`);
        loadSheet(name);
        audioInputContainer.style.display = "block";
      }

      /* --------------- Load sheet into table ------------------ */
      function loadSheet(name) {
        const ws = workbook.Sheets[name];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

        let html = `
  <table class="table table-striped table-bordered align-middle" style="table-layout:fixed;">
  <colgroup>
    <col style="width:5%">
    <col style="width:10%">
    <col style="width:85%">
  </colgroup>
  <thead class="table-dark">
    <tr><th>Ø±Ø¯ÛŒÙ</th><th>Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§</th><th>Ù…ØªÙ†</th></tr>
  </thead>
  <tbody>`;

        for (let i = 1; i < json.slice(1).length; i += 2) {
          const idx = Math.floor((i - 1) / 2);

          let combined = "";
          for (let j = i; j < i + 2 && j < json.slice(1).length; j++) {
            if (json[j].length > 0)
              combined += `<span>${json[j].join(" ")}</span><br>`;
          }

          html += `
    <tr>
      <td class="row-number">${idx + 1}</td>
      <td class="controls-cell">
        <button class="btn btn-primary btn-fixed mb-1" onclick="toggleAudio(${idx},this)">â–¶ Ù¾Ø®Ø´</button>
        <button class="btn btn-secondary btn-fixed mb-1" onclick="toggleText(${idx})">Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ</button>

        <button class="btn btn-danger btn-fixed mb-1" onclick="startRecording(${idx})">ğŸ™ Ø¶Ø¨Ø·</button>
        <button class="btn btn-warning btn-fixed mb-1" onclick="stopRecording(${idx})">â–  ØªÙˆÙ‚Ù</button>
        <span id="rec_${idx}" class="recording-indicator"></span>

        <audio id="myAudio_${idx}" controls class="w-100 mt-1" style="display:none"></audio>
      </td>
      <td class="dialog-cell" id="dialog_${idx}" style="display:none">${combined}</td>
    </tr>`;
        }

        html += "</tbody></table>";
        tableContainer.innerHTML = html;
      }

      /* --------------- Toggle audio playback ------------------ */
      function toggleAudio(index, btn) {
        if (currentAudio && !currentAudio.paused) {
          currentAudio.pause();
          if (currentBtn) currentBtn.textContent = "â–¶ Ù¾Ø®Ø´";
          if (currentAudio.datasetIndex == index) {
            currentAudio = null;
            currentBtn = null;
            return;
          }
        }

        currentAudio = new Audio(`audio${index + 1}.mp3`);
        currentAudio.datasetIndex = index;
        currentBtn = btn;
        btn.textContent = "â¹ ØªÙˆÙ‚Ù";
        currentAudio.play();

        currentAudio.onended = () => {
          btn.textContent = "â–¶ Ù¾Ø®Ø´";
          currentAudio = null;
          currentBtn = null;
        };
      }

      /* --------------- Toggle text ------------------ */
      function toggleText(index) {
        const el = document.getElementById(`dialog_${index}`);
        el.style.display = el.style.display === "none" ? "block" : "none";
      }

      /* --------------- Recording audio ------------------ */
      async function startRecording(index) {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(mediaStream);
          recordedChunks = [];

          mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => saveRecording(index);

          mediaRecorder.start();
          document.getElementById(`rec_${index}`).style.display =
            "inline-block";
          showToast("Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...");
        } catch (err) {
          showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†");
        }
      }

      function stopRecording(index) {
        if (mediaRecorder) {
          mediaRecorder.stop();
          mediaStream.getTracks().forEach((t) => t.stop());
          document.getElementById(`rec_${index}`).style.display = "none";
          showToast("Ø¶Ø¨Ø· Ù…ØªÙˆÙ‚Ù Ø´Ø¯");
        }
      }

      function saveRecording(index) {
        const blob = new Blob(recordedChunks, { type: "audio/webm" });
        const url = URL.createObjectURL(blob);
        const audioEl = document.getElementById(`myAudio_${index}`);
        audioEl.src = url;
        audioEl.style.display = "block";
        showToast("ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
      }

      /* --------------- Sidebar toggle ------------------ */
      function toggleSidebar() {
        sidebar.classList.toggle("collapsed");
      }

      window.onload = loadDefaultExcel;
    </script>
  </body>
</html>
